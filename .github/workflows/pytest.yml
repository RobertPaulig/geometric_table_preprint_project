name: pytest

permissions:
  contents: read
  statuses: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: code/requirements.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r code/requirements.txt
      - name: Quick python checks
        run: |
          python -m compileall -q code
          python - << 'PY'
          import sys
          sys.path.insert(0, "code")
          import geometric_table  # noqa: F401
          print("OK: import geometric_table")
          PY
      - name: Set Commit Status (test success)
        if: success()
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{\"state\":\"success\",\"context\":\"ci/test\",\"description\":\"python checks passed\",\"target_url\":\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
      - name: Set Commit Status (test failure)
        if: failure()
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{\"state\":\"failure\",\"context\":\"ci/test\",\"description\":\"python checks failed\",\"target_url\":\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

  test-chem:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: code/requirements.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r code/requirements.txt
      - name: Wave Atlas / M29 smoke (micro)
        env:
          PYTHONPATH: code
        run: |
          set -euo pipefail
          OUT_DIR="/tmp/ci_wave_atlas"
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"

          python code/scripts/m26_survival_dataset.py \
            --p-max 2000 \
            --Q0 100000 \
            --Q-list 1000000,2000000 \
            --seed 0 \
            --mersenne-strict 1 \
            --out-dir "$OUT_DIR" \
            --label ci_smoke

          DS="$OUT_DIR/ci_smoke/m26_dataset.csv"
          test -f "$DS"

          python code/scripts/m26_survival_model.py \
            --dataset-csv "$DS" \
            --fit-Q 1000000 \
            --eval-Q-list 1000000,2000000 \
            --model baseline_fit1M \
            --out-dir "$OUT_DIR/baseline_fit1M" \
            --seed 0

          python code/scripts/m26_survival_model.py \
            --dataset-csv "$DS" \
            --fit-Q 2000000 \
            --eval-Q-list 1000000,2000000 \
            --model baseline_fit2M \
            --out-dir "$OUT_DIR/baseline_fit2M" \
            --seed 0

          python code/scripts/m29_multiscale_model.py \
            --dataset-csv "$DS" \
            --fit-Q 1000000 \
            --eval-Q-list 1000000,2000000 \
            --bin-Q-list 1000000 \
            --model multiscale_fit1M \
            --out-dir "$OUT_DIR/multiscale_fit1M" \
            --seed 0

          python code/scripts/m29_multiscale_model.py \
            --dataset-csv "$DS" \
            --fit-Q 2000000 \
            --eval-Q-list 1000000,2000000 \
            --bin-Q-list 1000000,2000000 \
            --model multiscale_fit2M \
            --out-dir "$OUT_DIR/multiscale_fit2M" \
            --seed 0

          python code/scripts/m29_compare_models.py \
            --baseline-fit10M "$OUT_DIR/baseline_fit1M" \
            --baseline-fit20M "$OUT_DIR/baseline_fit2M" \
            --multiscale-fit10M "$OUT_DIR/multiscale_fit1M" \
            --multiscale-fit20M "$OUT_DIR/multiscale_fit2M" \
            --dataset-csv "$DS" \
            --Q-target-list 1000000,2000000 \
            --permutations 10 \
            --seed 123 \
            --out-dir "$OUT_DIR/compare"

          test -f "$OUT_DIR/compare/m29_compare_manifest.json"
          echo "OK: M29 smoke done"
      - name: Set Commit Status (test-chem success)
        if: success()
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{\"state\":\"success\",\"context\":\"ci/test-chem\",\"description\":\"wave atlas smoke passed\",\"target_url\":\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
      - name: Set Commit Status (test-chem failure)
        if: failure()
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{\"state\":\"failure\",\"context\":\"ci/test-chem\",\"description\":\"wave atlas smoke failed\",\"target_url\":\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"

  docker-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install TeX Live
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-luatex texlive-latex-extra texlive-fonts-recommended
      - name: Build Wave Atlas PDF (docs smoke)
        run: |
          cd docs
          lualatex wave_atlas.tex
          lualatex wave_atlas.tex
      - name: Set Commit Status (docker success)
        if: success()
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{\"state\":\"success\",\"context\":\"ci/docker\",\"description\":\"docs build passed\",\"target_url\":\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
      - name: Set Commit Status (docker failure)
        if: failure()
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{\"state\":\"failure\",\"context\":\"ci/docker\",\"description\":\"docs build failed\",\"target_url\":\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
